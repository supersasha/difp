/*
 * Color conversions
 */

__constant const float ref_x = 95.047f;
__constant const float ref_y = 100.0f;
__constant const float ref_z = 108.883f;

float4 lab_to_xyz_scalar(float4 c)
{
    float y = (c.x + 16.0f) / 116.0f;
    float x = c.y / 500.0f + y;
    float z = y - c.z / 200.0f;

    if(y > 0.206893034f)
        y = y * y * y;
    else
        y = (y - 16.0f/116.0f) / 7.787f;
    
    if(x > 0.206893034f)
        x = x * x * x;
    else
        x = (x - 16.0f/116.0f) / 7.787f;
    
    if(z > 0.206893034f)
        z = z * z * z;
    else
        z = (z - 16.0f/116.0f) / 7.787f;
    
    return (float4) (x * ref_x, y * ref_y, z * ref_z, 0.0f);
}

float4 xyz_to_srgb_scalar(float4 c)
{
    float x = c.x / 100.0f;
    float y = c.y / 100.0f;
    float z = c.z / 100.0f;

    float r = x *  3.2406f + y * -1.5372f + z * -0.4986f;
    float g = x * -0.9689f + y *  1.8758f + z *  0.0415f;
    float b = x *  0.0557f + y * -0.2040f + z *  1.0570f;

    if(r > 0.0031308f)
        r = 1.055f * native_powr(r, 1.0f / 2.4f) - 0.055f;
    else
        r = 12.92f * r;

    if(g > 0.0031308f)
        g = 1.055f * native_powr(g, 1.0f / 2.4f) - 0.055f;
    else
        g = 12.92f * g;

    if(b > 0.0031308f)
        b = 1.055f * native_powr(b, 1.0f / 2.4f) - 0.055f;
    else
        b = 12.92f * b;
    
    if(r < 0.0f)
        r = 0.0f;
    else if(r > 1.0f)
        r = 1.0f;

    if(g < 0.0f)
        g = 0.0f;
    else if(g > 1.0f)
        g = 1.0f;

    if(b < 0.0f)
        b = 0.0f;
    else if(b > 1.0f)
        b = 1.0f;
/*
    if (r < 0.0f || g < 0.0f || b < 0.0f)
        return (float4) (1.0f, 1.0f, 0.0f, 0.0f);
    if (r > 1.0f || g > 1.0f || b > 1.0f)
        return (float4) (1.0f, 0.0f, 1.0f, 0.0f);
*/
    return (float4) (r, g, b, 0.0f);
}

float4 xyz_to_lab_scalar(float4 c)
{
    float x = c.x / ref_x;
    float y = c.y / ref_y;
    float z = c.z / ref_z;

    if(x > 0.008856f)
        x = cbrt(x);
    else
        x = 7.787f * x + 16.0f/116.0f;

    if(y > 0.008856f)
        y = cbrt(y);
    else
        y = 7.787f * y + 16.0f/116.0f;

    if(z > 0.008856f)
        z = cbrt(z);
    else
        z = 7.787f * z + 16.0f/116.0f;

    return (float4) (116.0f * y - 16.0f, 500.0f * (x - y), 200.0f * (y - z), 0.0f);
}

float4 srgb_to_xyz_scalar(float4 c)
{
    float r = c.x;
    float g = c.y;
    float b = c.z;

    if(r > 0.04045f)
        r = native_powr((r + 0.055f) / 1.055f, 2.4f);
    else
        r /= 12.92f;

    if(g > 0.04045f)
        g = native_powr((g + 0.055f) / 1.055f, 2.4f);
    else
        g /= 12.92f;

    if(b > 0.04045)
        b = native_powr((b + 0.055f) / 1.055f, 2.4f);
    else
        b /= 12.92f;

    r *= 100.0f;
    g *= 100.0f;
    b *= 100.0f;

    float x = r * 0.4124f + g * 0.3576f + b * 0.1805f;
    float y = r * 0.2126f + g * 0.7152f + b * 0.0722f;
    float z = r * 0.0193f + g * 0.1192f + b * 0.9505f;

    return (float4) (x, y, z, 0.0f);
}

float4 xyz_to_cmccat_scalar(float4 c)
{

    return (float4)
    (
         0.7982 * c.x + 0.3389 * c.y - 0.1371 * c.z,
        -0.5918 * c.x + 1.5512 * c.y + 0.0406 * c.z,
         0.0008 * c.x + 0.0239 * c.y + 0.9753 * c.z,
         0.0f
    );
}

float4 cmccat_to_xyz_scalar(float4 c)
{
    return (float4)
    (
        1.0764500486786395 * c.x
            - 0.23766238809256302 * c.y
            + 0.16121233941392343 * c.z,
        0.41096432547977596 * c.x
            + 0.5543418041471032 * c.y
            + 0.03469387037312098 * c.z,
        -0.010953765423879379 * c.x
            - 0.013389356309486022 * c.y
            + 1.0243431217333654 * c.z,
        0.0f
    );
}

float4 lab_to_srgb_scalar(float4 c)
{
    return xyz_to_srgb_scalar(lab_to_xyz_scalar(c));
}

float4 srgb_to_lab_scalar(float4 c)
{
    return xyz_to_lab_scalar(srgb_to_xyz_scalar(c));
}

__kernel void lab_to_srgb(__global const float4 *in, __global float4 *out, int N)
{
    int i = get_global_id(0);
    out[i] = lab_to_srgb_scalar(in[i]);
}

__kernel void srgb_to_lab(__global const float4 *in, __global float4 *out, int N)
{
    int i = get_global_id(0);
    out[i] = srgb_to_lab_scalar(in[i]);
}

float4 lab_to_lch_scalar(float4 c)
{
    return (float4) (c.x, hypot(c.y, c.z), atan2(c.z, c.y), 0);
}

float4 lch_to_lab_scalar(float4 c)
{
    return (float4) (c.x, c.y * cos(c.z), c.y * sin(c.z), 0);
}

__kernel void lab_to_lch(__global const float4 *in, __global float4 *out)
{
    int i = get_global_id(0);
    out[i] = lab_to_lch_scalar(in[i]);
}

__kernel void lch_to_lab(__global const float4 *in, __global float4 *out)
{
    int i = get_global_id(0);
    out[i] = lch_to_lab_scalar(in[i]);
}

__kernel void balance_cmccat(
        __global const float4 * in,
        __global float4 * out,
        float4 lms_w,
        float D,
        float Yw)
{
    int i = get_global_id(0);
    
    float4 lms = xyz_to_cmccat_scalar(lab_to_xyz_scalar(in[i]));
    float4 lms_c = (float4) (
        (Yw / lms_w.x * D + 1 - D) * lms.x,
        (Yw / lms_w.y * D + 1 - D) * lms.y,
        (Yw / lms_w.z * D + 1 - D) * lms.z,
        0.0f
    );
    out[i] = xyz_to_lab_scalar(cmccat_to_xyz_scalar(lms_c));
}

/*
 * NL-means denoise
 */

__kernel void zero (__global float * OUT)
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
    
    OUT[idx] = 0;
}

__kernel void gauss_rows (
    __global const float * restrict IN,
    __global float * restrict OUT)
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
    
    float ga = (col > 1) ? IN[idx-2] : 0;
    float gb = (col > 0) ? IN[idx-1] : 0;
    float gc = IN[idx];
    float gd = (col < ncols - 1) ? IN[idx+1] : 0;
    float ge = (col < ncols - 2) ? IN[idx+2] : 0;
    OUT[idx] = (ga + ge) * 0.0625 + (gb + gd) * 0.25 + gc * 0.375;
}

__kernel void gauss_cols (
    __global const float * restrict IN,
    __global float * restrict OUT)
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
    
    float ga = (row > 1) ? IN[idx - ncols - ncols] : 0;
    float gb = (row > 0) ? IN[idx - ncols] : 0;
    float gc = IN[idx];
    float gd = (row < nrows - 1) ? IN[idx + ncols] : 0;
    float ge = (row < nrows - 2) ? IN[idx + ncols + ncols] : 0;
    OUT[idx] = (ga + ge) * 0.0625 + (gb + gd) * 0.25 + gc * 0.375;
}

__kernel void shift (
    __private int i,
    __private int j,
    __global const float * restrict IN,
    __global float * restrict SHIFTED,
    __global float * restrict SQUARED_DIFF)
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
    
    int r = row + i;
    int c = col + j;

    float f = 0;
    if (r >= 0 && c >= 0 && r < nrows && c < ncols) {
        f = IN[r * ncols + c];
    }
    float d = f - IN[idx];
    SHIFTED[idx] = f;
    SQUARED_DIFF[idx] = d * d;
}

__kernel void weights (
    __global const float * restrict GAUSSIAN,
    __global const float * restrict SHIFTED,
    __global float * restrict WSUM,
    __global float * restrict OUT)
{
    float h = 1.0;
    float h2 = h * h;
    
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
            
    float w = exp(-GAUSSIAN[idx] / h2); // native_exp?
    WSUM[idx] += w;
    OUT[idx] += w * SHIFTED[idx];
}

__kernel void normize (
    __global const float * restrict IN,
    __global const float * restrict WSUM,
    __global float * restrict OUT)
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;

    OUT[idx] = IN[idx] / WSUM[idx];
}

/*
 * Tone mapping
 */

__kernel void haars_rows (
    __global const float * IN,
    __global float * OUT,
    float ql, // left quotient
    float qr, // right quotient
    float zn  // number of zeros between
    )
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
    int ks2 = (zn + 2) / 2;
    
    float kl = (col > ks2 - 1)     ? IN[idx - ks2] : IN[idx-col];
    float kr = (col < ncols - ks2) ? IN[idx + ks2] : IN[idx+ncols-1];

    OUT[idx] = kl * ql + kr * qr;
}

__kernel void haars_cols (
    __global const float * IN,
    __global float * OUT,
    float qt, // top quotient
    float qb, // bottom quotient
    float zn  // number of zeros between
    )
{
    int col = get_global_id(0);
    int row = get_global_id(1);
    int ncols = get_global_size(0);
    int nrows = get_global_size(1);
    int idx = row * ncols + col;
    int ks2 = (zn + 2) / 2;
    
    float kt = (row > ks2 - 1)     ? IN[idx - ncols * ks2] : IN[col];
    float kb = (row < nrows - ks2) ? IN[idx + ncols * ks2] : IN[(nrows-1)*ncols+col];

    OUT[idx] = kt * qt + kb * qb;
}

__kernel void sum(
    __global const float * in,
    __global float * partialSums
    )
{
    int local_id = get_local_id(0);
    int group_size = get_local_size(0);

    float s = work_group_reduce_add(in[get_global_id(0)]);
    
    if(local_id == 0) {
        partialSums[get_group_id(0)] = s;
    }
}

__kernel void compress_range_lopass_helper (
    __global float * in,
    __global float * in_a,
    __global float * out,
    __global float * delta,
    float gamma,
    float eps
    )
{
    int i = get_global_id(0);
    out[i] = in[i] * native_powr((in_a[i] + eps) / delta[0], gamma - 1);
}

__kernel void add(
    __global float * a,
    __global float * b,
    __global float * out
    )
{
    int i = get_global_id(0);
    out[i] = a[i] + b[i]; 
}

__kernel void mult_scalar(
    __global float * in,
    __global float * out,
    float scalar
    )
{
    int i = get_global_id(0);
    out[i] = in[i] * scalar; 
}

__kernel void abs_all(
    __global float * in,
    __global float * out
    )
{
    int i = get_global_id(0);
    out[i] = fabs(in[i]); 
}

__kernel void copy_all(
    __global float * in,
    __global float * out
    )
{
    int i = get_global_id(0);
    out[i] = in[i];
}

__constant float LIGHT[65] = {
    // CIE D65
    ///*
    49.9755, 52.3118, 54.6482, 68.7015, 82.7549, 87.1204, 91.486, 92.4589, 
    93.4318, 90.057,  86.6823, 95.7736, 104.865, 110.936, 117.008, 117.41,
    117.812, 116.336, 114.861, 115.392, 115.923, 112.367, 108.811, 109.082,
    109.354, 108.578, 107.802, 106.296, 104.79,  106.239, 107.689, 106.047,
    104.405, 104.225, 104.046, 102.023, 100,     98.1671, 96.3342, 96.0611,
    95.788,  92.2368, 88.6856, 89.3459, 90.0062, 89.8026, 89.5991, 88.6489,
    87.6987, 85.4936, 83.2886, 83.4939, 83.6992, 81.863,  80.0268, 80.1207,
    80.2146, 81.2462, 82.2778, 80.281,  78.2842, 74.0027, 69.7213, 70.6652,
    71.6091
    //*/
    // CIE A
    /*
    9.7951,10.8996,12.0853,13.3543,14.708,16.148,17.6753,19.2907,20.995,22.7883,24.6709,26.6425,28.7027,30.8508,33.0859,35.4068,37.8121,40.3002,42.8693,45.5174,48.2423,51.0418,53.9132,56.8539,59.8611,62.932,66.0635,69.2525,72.4959,75.7903,79.1326,82.5193,85.947,89.4124,92.912,96.4423,100,103.582,107.184,110.803,114.436,118.08,121.731,125.386,129.043,132.697,136.346,139.988,143.618,147.235,150.836,154.418,157.979,161.516,165.028,168.51,171.963,175.383,178.769,182.118,185.429,188.701,191.931,195.118,198.261
    */
    // Equal energy
    /*
    100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
    100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
    100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
    100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
    100, 100, 100, 100, 100
    */
};

__constant float CIE_A[65] = {
    9.7951,10.8996,12.0853,13.3543,14.708,16.148,17.6753,19.2907,20.995,22.7883,24.6709,26.6425,28.7027,30.8508,33.0859,35.4068,37.8121,40.3002,42.8693,45.5174,48.2423,51.0418,53.9132,56.8539,59.8611,62.932,66.0635,69.2525,72.4959,75.7903,79.1326,82.5193,85.947,89.4124,92.912,96.4423,100,103.582,107.184,110.803,114.436,118.08,121.731,125.386,129.043,132.697,136.346,139.988,143.618,147.235,150.836,154.418,157.979,161.516,165.028,168.51,171.963,175.383,178.769,182.118,185.429,188.701,191.931,195.118,198.261
};

__constant float CIE_D65[65] = {
    49.9755, 52.3118, 54.6482, 68.7015, 82.7549, 87.1204, 91.486, 92.4589, 
    93.4318, 90.057,  86.6823, 95.7736, 104.865, 110.936, 117.008, 117.41,
    117.812, 116.336, 114.861, 115.392, 115.923, 112.367, 108.811, 109.082,
    109.354, 108.578, 107.802, 106.296, 104.79,  106.239, 107.689, 106.047,
    104.405, 104.225, 104.046, 102.023, 100,     98.1671, 96.3342, 96.0611,
    95.788,  92.2368, 88.6856, 89.3459, 90.0062, 89.8026, 89.5991, 88.6489,
    87.6987, 85.4936, 83.2886, 83.4939, 83.6992, 81.863,  80.0268, 80.1207,
    80.2146, 81.2462, 82.2778, 80.281,  78.2842, 74.0027, 69.7213, 70.6652,
    71.6091
};

// ---------------- 
__constant float RHO[3][65] = {
    {0.021592459, 0.0204242325358398, 0.020293111, 0.02086552521416019, 0.021807906, 0.02282855998251941, 0.023803297, 0.02464009885576215, 0.025208132, 0.025421760844432, 0.025414957, 0.02526731101650986, 0.024621282, 0.02313591183952857, 0.020973705, 0.01842059912537584, 0.015752802, 0.01324406453396805, 0.01116804, 0.009694561238751958, 0.008578277, 0.00754018676102412, 0.006581877, 0.00577260484215156, 0.005171723, 0.004801429120369637, 0.004545205, 0.004298721301369891, 0.00414512, 0.004177724424150801, 0.004343112, 0.004616968002026905, 0.005238155, 0.006325178567741576, 0.007251939, 0.00810218397700679, 0.012543656, 0.02234158202423126, 0.028067132, 0.03161178042606817, 0.091342277, 0.256591440646496, 0.484081092, 0.7086703248629476, 0.870378324, 0.9316550065267137, 0.939513128, 0.9487735842801976, 0.960926994, 0.9668912679774958, 0.968623763, 0.9699668965598193, 0.971263883, 0.972069729658227, 0.972285819, 0.9720248911822725, 0.971898742, 0.972355786237683, 0.972691859, 0.9722525206169955, 0.971734812, 0.9718912206693349, 0.97234454, 0.9724351398306652, 0.97150339},

    {0.010542406, 0.0106527511878285, 0.010878976, 0.0110671923121715, 0.011063512, 0.01082300406348551, 0.010736566, 0.01113611430888646, 0.011681813, 0.01202265720096865, 0.012434719, 0.01332372051223894, 0.014986907, 0.0174924111250756, 0.020100392, 0.02293149236245866, 0.030356263, 0.04564148617508976, 0.06338896199999999, 0.08821061343718227, 0.173423837, 0.3571875328261811, 0.5683211419999999, 0.7269536898830933, 0.827791998, 0.885071023266446, 0.916560468, 0.9378160546761228, 0.952002841, 0.9597703276540627, 0.964096452, 0.9677820182076264, 0.970590861, 0.9718907972654317, 0.972502542, 0.9727039082306469, 0.969148203, 0.9602814006869809, 0.955344651, 0.9522299161464298, 0.892637233, 0.7274358891022998, 0.5003641, 0.2768530308193709, 0.116236717, 0.05545291449521649, 0.047951391, 0.03940582494976309, 0.027873526, 0.02195725708073115, 0.020057963, 0.0187348732273123, 0.017382174, 0.01615647326001965, 0.015429109, 0.01540867773260911, 0.01543808, 0.0149431091845439, 0.014546826, 0.0148538505292153, 0.015197773, 0.0148727078235949, 0.014285896, 0.0141228601764051, 0.015069123},
    {0.967865135, 0.9689230152672739, 0.968827912, 0.9680672819827261, 0.967128582, 0.9663484360518217, 0.965460137, 0.964223786809987, 0.963110055, 0.9625555819582305, 0.962150324, 0.961408968482091, 0.960391811, 0.9593716769884058, 0.958925903, 0.9586479086892863, 0.953890935, 0.9411144486294492, 0.925442998, 0.9020948277929171, 0.817997886, 0.6352722685738825, 0.42509696, 0.267273689036553, 0.167036273, 0.1101275467799057, 0.078894327, 0.05788522359382422, 0.043852038, 0.03605194671979741, 0.031560435, 0.02760101327698613, 0.024170984, 0.02178402442225805, 0.020245519, 0.01919390703398164, 0.01830814, 0.01737701731681537, 0.016588218, 0.01615830407375686, 0.01602049, 0.01597267038815718, 0.015554808, 0.0144766432486144, 0.013384959, 0.0128920843673852, 0.012535491, 0.0118205995318448, 0.011199484, 0.0111514747552356, 0.011318274, 0.0112982361972128, 0.011353953, 0.01177380270591321, 0.012285073, 0.01256643547913437, 0.012663188, 0.01270111550254932, 0.012761325, 0.01289363976066837, 0.013067426, 0.01323607882977721, 0.013369566, 0.01344199842022279, 0.013427487}
    };

// Make it -10 when it is 0
__constant float STATUS_M[3][65] = {
    {-60.291000, -58.991000, -57.691000, -56.391000, -55.091000, -53.791000, -52.491000, -51.191000, -49.891000, -48.591000, -47.291000, -45.991000, -44.691000, -43.391000, -42.091000, -40.791000, -39.491000, -38.191000, -36.891000, -35.591000, -34.291000, -32.991000, -31.691000, -30.391000, -29.091000, -27.791000, -26.491000, -25.191000, -23.891000, -22.591000, -21.291000, -19.991000, -18.691000, -17.391000, -16.091000, -14.791000, -13.491000, -12.191000, -10.891000, -9.591000,-8.291000, -6.991000, -5.691000, -4.391000, -3.091000, -1.791000, -0.491000, 0.824040, 2.109000, 3.497183, 4.479000, 4.846277, 5.000000, 4.968707, 4.899000, 4.759728, 4.578000, 4.418271, 4.252000, 4.067352, 3.875000, 3.683936, 3.491000, 3.296005, 3.099000},
    {-8.388000, -7.858000, -7.328000, -6.798000, -6.268000, -5.738000, -5.208000, -4.678000, -4.148000, -3.618000, -3.088000, -2.558000, -2.028000, -1.498000, -0.968000, -0.438000, 0.092000, 0.622313, 1.152000, 1.686787, 2.207000, 2.710133, 3.156000, 3.508331, 3.804000, 4.055549, 4.272000, 4.463102, 4.626000, 4.764237, 4.872000, 4.957048, 5.000000, 4.998716, 4.995000, 4.934949, 4.818000, 4.662455, 4.458000, 4.210811, 3.915000, 3.568473, 3.172000, 2.731815, 2.239000, 1.672818, 1.070000, 0.471963, -0.130000, -0.730000, -1.330000, -1.930000, -2.530000, -3.130000, -3.730000, -4.330000, -4.930000, -5.530000, -6.130000, -6.730000, -7.330000, -7.930000, -8.530000, -9.130000, -9.730000},
    {-5.397000, -4.147000, -2.897000, -1.647000, -0.397000, 0.887106, 2.103000, 3.281977, 4.111000, 4.433957, 4.632000, 4.771515, 4.871000, 4.956445, 5.000000, 4.986780, 4.955000, 4.874360, 4.743000, 4.568359, 4.343000, 4.066481, 3.743000, 3.396307, 2.990000, 2.495219, 1.852000, 0.839493, -0.348000, -1.448000, -2.548000, -3.648000, -4.748000, -5.848000, -6.948000, -8.048000, -9.148000, -10.248000, -11.348000, -12.448000, -13.548000, -14.648000, -15.748000, -16.848000, -17.948000, -19.048000, -20.148000, -21.248000, -22.348000, -23.465978, -24.548000, -25.499164, -26.478000, -27.692959, -28.948000, -30.063899, -31.148000, -32.248000, -33.348000, -34.448000, -35.548000, -36.648000, -37.748000, -38.848000, -39.948000}
};

__constant float DENSITOMETRY_S_H[65] = {
    10.000000, 10.887500, 12.000000, 13.425000, 15.000000, 16.500000, 18.000000, 19.446429, 21.000000, 22.928571, 25.000000, 27.000000, 29.000000, 30.944444, 33.000000, 35.430556, 38.000000, 40.500000, 43.000000, 45.443182, 48.000000, 50.931818, 54.000000, 57.000000, 60.000000, 63.000000, 66.000000, 68.942308, 72.000000, 75.432692, 79.000000, 82.500000, 86.000000, 89.500000, 93.000000, 96.500000, 100.000000, 103.738636, 107.000000, 109.136364, 111.000000, 113.300000, 115.000000, 115.512500, 116.000000, 117.687500, 119.000000, 118.333333, 117.000000, 115.266667, 113.000000, 110.081818, 107.000000, 104.500000, 102.000000, 99.125874, 96.000000, 92.676683, 89.000000, 84.574449, 80.000000, 76.052288, 72.000000, 67.263889, 62.000000
};
    /*
    {-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0,-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0,-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0,-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, 0.775513,2.109000, 3.466210, 4.479000, 4.846277, 5.000000, 4.968707, 4.899000, 4.759728, 4.578000, 4.418271, 4.252000, 4.067352,3.875000, 3.683936, 3.491000, 3.296005, 3.099000},
    {-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, 0.024837, 0.092000, 0.510976, 1.152000, 1.686787, 2.207000, 2.710133, 3.156000, 3.508331, 3.804000, 4.055549, 4.272000, 4.463102, 4.626000, 4.764237, 4.872000, 4.957048, 5.000000, 4.998716, 4.995000, 4.934949, 4.818000, 4.662455, 4.458000, 4.210811, 3.915000, 3.568473, 3.172000, 2.731815, 2.239000, 1.664445, 1.070000, 0.395336, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0},
    {-10.0, -10.0, -10.0, -10.0, -10.0, 0.794700, 2.103000, 3.260383, 4.111000, 4.433957, 4.632000, 4.771515, 4.871000, 4.956445, 5.000000, 4.986780, 4.955000, 4.874360, 4.743000, 4.568359, 4.343000, 4.066481, 3.743000, 3.396307, 2.990000, 2.483930, 1.852000, 0.749781, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0}
    */

__constant float STATUS_A[3][65] = {
    {-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, 0.997467, 2.568000, 3.812504, 4.638000, 4.896029, 5.000000, 4.957244, 4.871000, 4.752040, 4.604000, 4.452305, 4.286000, 4.095232, 3.900000, 3.725500, 3.551000, 3.360616, 3.165000, 2.970937, 2.776000, 2.580001, 2.383000},
    {-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, 0.590581, 1.650000, 2.803982, 3.822000, 4.424023, 4.782000, 4.935414, 5.000000, 4.970295, 4.906000, 4.798153, 4.644000, 4.454583, 4.221000, 3.941115, 3.609000, 3.222086, 2.766000, 2.218671, 1.579000, 0.620097, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0},
    {-10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, 1.573586, 3.602000, 4.398523, 4.819000, 4.948891, 5.000000, 4.972905, 4.912000, 4.797650, 4.620000, 4.374881, 4.040000, 3.572193, 2.989000, 2.302860, 1.566000, 0.725914, 0.165000, 0.045596, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0, -10.0}
    };

__constant float A1931_78[65][3] = {
    {2.689900e-003,2.000000e-004,1.226000e-002},
    {5.310500e-003,3.955600e-004,2.422200e-002},
    {1.078100e-002,8.000000e-004,4.925000e-002},
    {2.079200e-002,1.545700e-003,9.513500e-002},
    {3.798100e-002,2.800000e-003,1.740900e-001},
    {6.315700e-002,4.656200e-003,2.901300e-001},
    {9.994100e-002,7.400000e-003,4.605300e-001},
    {1.582400e-001,1.177900e-002,7.316600e-001},
    {2.294800e-001,1.750000e-002,1.065800e+000},
    {2.810800e-001,2.267800e-002,1.314600e+000},
    {3.109500e-001,2.730000e-002,1.467200e+000},
    {3.307200e-001,3.258400e-002,1.579600e+000},
    {3.333600e-001,3.790000e-002,1.616600e+000},
    {3.167200e-001,4.239100e-002,1.568200e+000},
    {2.888200e-001,4.680000e-002,1.471700e+000},
    {2.596900e-001,5.212200e-002,1.374000e+000},
    {2.327600e-001,6.000000e-002,1.291700e+000},
    {2.099900e-001,7.294200e-002,1.235600e+000},
    {1.747600e-001,9.098000e-002,1.113800e+000},
    {1.328700e-001,1.128400e-001,9.422000e-001},
    {9.194400e-002,1.390200e-001,7.559600e-001},
    {5.698500e-002,1.698700e-001,5.864000e-001},
    {3.173100e-002,2.080200e-001,4.466900e-001},
    {1.461300e-002,2.580800e-001,3.411600e-001},
    {4.849100e-003,3.230000e-001,2.643700e-001},
    {2.321500e-003,4.054000e-001,2.059400e-001},
    {9.289900e-003,5.030000e-001,1.544500e-001},
    {2.927800e-002,6.081100e-001,1.091800e-001},
    {6.379100e-002,7.100000e-001,7.658500e-002},
    {1.108100e-001,7.951000e-001,5.622700e-002},
    {1.669200e-001,8.620000e-001,4.136600e-002},
    {2.276800e-001,9.150500e-001,2.935300e-002},
    {2.926900e-001,9.540000e-001,2.004200e-002},
    {3.622500e-001,9.800400e-001,1.331200e-002},
    {4.363500e-001,9.949500e-001,8.782300e-003},
    {5.151300e-001,1.000100e+000,5.857300e-003},
    {5.974800e-001,9.950000e-001,4.049300e-003},
    {6.812100e-001,9.787500e-001,2.921700e-003},
    {7.642500e-001,9.520000e-001,2.277100e-003},
    {8.439400e-001,9.155800e-001,1.970600e-003},
    {9.163500e-001,8.700000e-001,1.806600e-003},
    {9.770300e-001,8.162300e-001,1.544900e-003},
    {1.023000e+000,7.570000e-001,1.234800e-003},
    {1.051300e+000,6.948300e-001,1.117700e-003},
    {1.055000e+000,6.310000e-001,9.056400e-004},
    {1.036200e+000,5.665400e-001,6.946700e-004},
    {9.923900e-001,5.030000e-001,4.288500e-004},
    {9.286100e-001,4.417200e-001,3.181700e-004},
    {8.434600e-001,3.810000e-001,2.559800e-004},
    {7.398300e-001,3.205200e-001,1.567900e-004},
    {6.328900e-001,2.650000e-001,9.769400e-005},
    {5.335100e-001,2.170200e-001,6.894400e-005},
    {4.406200e-001,1.750000e-001,5.116500e-005},
    {3.545300e-001,1.381200e-001,3.601600e-005},
    {2.786200e-001,1.070000e-001,2.423800e-005},
    {2.148500e-001,8.165200e-002,1.691500e-005},
    {1.616100e-001,6.100000e-002,1.190600e-005},
    {1.182000e-001,4.432700e-002,8.148900e-006},
    {8.575300e-002,3.200000e-002,5.600600e-006},
    {6.307700e-002,2.345400e-002,3.954400e-006},
    {4.583400e-002,1.700000e-002,2.791200e-006},
    {3.205700e-002,1.187200e-002,1.917600e-006},
    {2.218700e-002,8.210000e-003,1.313500e-006},
    {1.561200e-002,5.772300e-003,9.151900e-007},
    {1.109800e-002,4.102000e-003,6.476700e-007},
};

__constant float E1931_78[65][3] = { // 380 - 700
 {0.0001496284173324329, -0.0001512010236612619, 0.0004879574540342557},
 {0.0002948405566846667, -0.00029813994761045, 0.0009641626803456921},
 {0.0005969739329310309, -0.0006046724906690117, 0.001960784834866368},
 {0.001146945782897091, -0.001163546786410836, 0.003788477562505623},
 {0.002090266259752724, -0.002124920861282664, 0.006933977502889304},
 {0.003458971364661459, -0.003524318690010961, 0.01155935828305472},
 {0.00543213048370584, -0.005551734899228202, 0.01835665836701863},
 {0.008527574035064201, -0.008745096400383462, 0.02917829140316796},
 {0.01218719652868474, -0.01254802078991394, 0.04253532055632611},
 {0.01452354328407154, -0.01504080955108653, 0.05253171049209103},
 {0.01543637072057205, -0.01610200057310178, 0.05872989000782881},
 {0.01544750799845994, -0.01628634612531906, 0.06338017845658404},
 {0.01426273406179365, -0.01526054910936313, 0.06506267635122429},
 {0.01186011975679594, -0.01301842414291194, 0.06336841581197394},
 {0.008646816493985431, -0.009976696383157629, 0.05978815043052859},
 {0.005116712854028471, -0.00664242051626065, 0.05619858760049393},
 {0.001251326723859439, -0.002972086213655827, 0.05328536426287857},
 {-0.003202287155232748, 0.001329456581524942, 0.05152200141884338},
 {-0.008914359237981045, 0.007171502932120197, 0.04717979116733194},
 {-0.01506069389485542, 0.01380556810655221, 0.04080944244523332},
 {-0.0212188286221146, 0.0207978715166751, 0.0338116426307383},
 {-0.02733029268352749, 0.027984063950495, 0.02747954730973567},
 {-0.03339783124017649, 0.03547666636532135, 0.02234928470561239},
 {-0.04043555974562271, 0.04428437848569238, 0.01872323502095588},
 {-0.04883667960559386, 0.05490716886868416, 0.01641707139773943},
 {-0.05869881573851964, 0.06763420328352882, 0.01500061413219531},
 {-0.06900376199848271, 0.08163875594212226, 0.01386512358233661},
 {-0.07806252462867065, 0.0952099642271448, 0.01277712506433126},
 {-0.0843435132271167, 0.1065183210037817, 0.01183804186106326},
 {-0.08640920339832982, 0.1136484859182169, 0.01088900438964483},
 {-0.08452708253992496, 0.1167317141761939, 0.009694012851354671},
 {-0.08002467495686132, 0.1170170726524613, 0.008310674970737932},
 {-0.07293889114506759, 0.1145154207287711, 0.006739302392765375},
 {-0.06336891698008892, 0.109376168172342, 0.004983388966400278},
 {-0.05154260948185388, 0.1018807917398723, 0.003051109058488076},
 {-0.03760015280751908, 0.09222207690371496, 0.000931182031692128},
 {-0.02166882495439809, 0.08046167539979518, -0.0013763873141661},
 {-0.004022337219238535, 0.06673936298970794, -0.003846831170953794},
 {0.01487602859605807, 0.05143102678410408, -0.006425771887274515},
 {0.03442879791912283, 0.03502038357365685, -0.009038479445245093},
 {0.05384770601468025, 0.01810745958955519, -0.01158383219845547},
 {0.07218864364089167, 0.001434373836295911, -0.0139426281225841},
 {0.0885380878255987, -0.01416520891550778, -0.01599611213501072},
 {0.1020090241186127, -0.02789124615602601, -0.01762031703328261},
 {0.1111595037281677, -0.03862380469441987, -0.01862896737319595},
 {0.1162382895774413, -0.04647468983760769, -0.01905806930403166},
 {0.1165778349296999, -0.05086331574326712, -0.01882260720225655},
 {0.1129257715068756, -0.05223989123584105, -0.01802592762305127},
 {0.1052517045899909, -0.05069303223797276, -0.01666028152623697},
 {0.09413400068115792, -0.04665839237206323, -0.01480964300305627},
 {0.08174645146697553, -0.04138875357854586, -0.01280051393103628},
 {0.06975470789721455, -0.03591137569055827, -0.01088113059705021},
 {0.05817112773134336, -0.03033813806965957, -0.009046723362412494},
 {0.04716188173632588, -0.02484179131363488, -0.007317368330781207},
 {0.03726896067712073, -0.01977094019926495, -0.005772659222459686},
 {0.02885270788645798, -0.01538347228008408, -0.004463633866847281},
 {0.02175849321316427, -0.01163859066401756, -0.003363495681735876},
 {0.01595212138115972, -0.008558529802105716, -0.002464122175644567},
 {0.01159417854955085, -0.006234615647535821, -0.001789956931652925},
 {0.008539439810071906, -0.004599467332427692, -0.001317828158935075},
 {0.006210699803504581, -0.003348958010344955, -0.0009581856716769172},
 {0.004346253353448532, -0.002345209895415726, -0.0006704265569025207},
 {0.003008983410120751, -0.00162422691234037, -0.0004641054542580858},
 {0.002117911718920551, -0.001143651525168292, -0.0003266372488902393},
 {0.001505720674417754, -0.000813191362644736, -0.0002322132265649488}
};

__constant float FILTERS[11][65] = {
{40.000, 44.181, 50.000, 59.347, 67.600, 70.845, 73.100, 75.322, 76.800, 77.431, 77.700, 77.323, 76.500, 74.993, 73.000, 71.108, 69.000, 66.436, 63.600, 60.658, 57.600, 54.457, 51.300, 48.218, 45.200, 42.242, 39.400, 36.695, 34.200, 31.948, 30.000, 28.442, 27.100, 25.837, 24.800, 24.075, 23.500, 22.917, 22.600, 22.600, 22.600, 22.832, 23.200, 23.518, 23.700, 23.552, 23.200, 22.306, 21.000, 19.615, 18.200, 16.888, 15.800, 15.053, 14.500, 14.100, 13.800, 13.600, 13.400, 13.089, 12.700, 12.139, 11.700, 11.558, 11.500},
{65.100, 65.100, 65.100, 65.100, 65.100, 65.364, 65.900, 66.629, 67.600, 68.832, 70.200, 71.542, 72.800, 73.895, 74.800, 75.444, 76.000, 76.587, 77.100, 77.484, 77.800, 78.076, 78.300, 78.454, 78.600, 78.787, 79.000, 79.225, 79.500, 79.907, 80.400, 80.958, 81.500, 81.961, 82.300, 82.486, 82.600, 82.656, 82.700, 82.744, 82.800, 82.912, 83.100, 83.488, 84.000, 84.487, 85.000, 85.557, 86.100, 86.605, 87.000, 87.226, 87.400, 87.555, 87.700, 87.858, 88.000, 88.100, 88.200, 88.333, 88.500, 88.761, 89.000, 89.129, 89.200},
{55.1, 55.1, 55.100, 55.100, 55.100, 55.322, 55.800, 56.576, 57.700, 59.227, 61.000, 62.794, 64.500, 65.952, 67.200, 68.219, 69.100, 69.940, 70.600, 70.996, 71.300, 71.546, 71.800, 72.222, 72.600, 72.767, 72.900, 73.027, 73.200, 73.737, 74.500, 75.274, 76.000, 76.556, 77.000, 77.356, 77.600, 77.712, 77.800, 77.900, 78.000, 78.084, 78.200, 78.538, 79.100, 79.953, 81.000, 82.119, 83.100, 83.707, 84.200, 84.693, 85.100, 85.375, 85.600, 85.800, 86.000, 86.243, 86.500, 86.750, 87.000, 87.250, 87.500, 87.750, 88.000},
{46.100, 46.100, 46.100, 46.100, 46.100, 46.247, 46.600, 47.548, 49.000, 50.604, 52.500, 54.867, 57.200, 58.979, 60.500, 61.903, 63.000, 63.683, 64.200, 64.627, 65.000, 65.356, 65.700, 66.116, 66.400, 66.451, 66.500, 66.673, 67.000, 67.750, 68.800, 69.976, 71.000, 71.589, 72.000, 72.298, 72.500, 72.606, 72.700, 72.822, 73.000, 73.404, 74.000, 74.696, 75.600, 76.987, 78.500, 79.763, 80.800, 81.525, 82.100, 82.603, 83.000, 83.262, 83.500, 83.787, 84.100, 84.443, 84.800, 85.157, 85.500, 85.800, 86.100, 86.437, 86.800},
{38.200, 38.200, 38.200, 38.200, 38.200, 38.254, 38.400, 39.334, 41.000, 43.099, 45.500, 47.790, 50.000, 52.082, 53.900, 55.342, 56.500, 57.404, 58.100, 58.576, 59.000, 59.507, 60.000, 60.457, 60.800, 60.958, 61.100, 61.317, 61.600, 61.950, 62.500, 64.255, 66.100, 66.814, 67.300, 67.708, 68.000, 68.172, 68.300, 68.388, 68.500, 68.863, 69.500, 70.588, 72.000, 73.466, 75.000, 76.594, 78.000, 79.021, 79.800, 80.358, 80.800, 81.172, 81.500, 81.791, 82.100, 82.542, 83.000, 83.350, 83.700, 84.136, 84.600, 85.050, 85.500},
{30.700, 30.700, 30.700, 30.700, 30.700, 30.944, 31.500, 32.632, 34.300, 36.318, 38.600, 40.907, 43.200, 45.429, 47.400, 48.946, 50.200, 51.213, 52.000, 52.536, 53.000, 53.479, 54.000, 54.719, 55.400, 55.827, 56.200, 56.548, 57.000, 58.051, 59.500, 61.163, 62.700, 63.750, 64.500, 64.962, 65.300, 65.591, 65.800, 65.900, 66.000, 66.190, 66.500, 67.121, 68.100, 69.714, 71.600, 73.231, 74.700, 75.963, 77.000, 77.790, 78.400, 78.821, 79.200, 79.650, 80.100, 80.500, 80.900, 81.332, 81.800, 82.336, 82.900, 83.450, 84.000},
{80.100, 80.100, 80.100, 80.100, 80.100, 80.357, 80.800, 81.208, 81.600, 81.948, 82.200, 82.338, 82.400, 82.400, 82.400, 82.153, 81.700, 81.243, 80.700, 80.023, 79.300, 78.650, 78.000, 77.300, 76.600, 75.944, 75.300, 74.620, 74.000, 73.486, 73.100, 72.874, 72.700, 72.557, 72.400, 72.100, 71.800, 71.600, 71.500, 71.500, 71.500, 71.600, 71.700, 71.643, 71.500, 71.037, 70.300, 69.432, 68.500, 67.675, 66.900, 66.130, 65.500, 65.072, 64.800, 64.678, 64.600, 64.546, 64.500, 64.454, 64.400, 64.283, 64.200, 64.312, 64.600},
{76.700, 76.700, 76.700, 76.700, 76.700, 77.194, 78.000, 78.668, 79.200, 79.538, 79.700, 79.700, 79.700, 79.538, 79.200, 78.688, 78.000, 77.198, 76.300, 75.386, 74.400, 73.250, 72.100, 71.127, 70.200, 69.244, 68.300, 67.330, 66.500, 65.923, 65.500, 65.229, 65.000, 64.760, 64.500, 64.158, 63.800, 63.419, 63.200, 63.200, 63.200, 63.300, 63.400, 63.279, 63.000, 62.405, 61.500, 60.301, 59.000, 57.914, 56.900, 55.853, 55.000, 54.467, 54.100, 53.831, 53.700, 53.700, 53.700, 53.617, 53.500, 53.433, 53.400, 53.612, 54.100},
{73.400, 73.400, 73.400, 73.400, 73.400, 74.013, 75.000, 75.759, 76.400, 76.927, 77.200, 77.200, 77.200, 77.005, 76.600, 76.001, 75.200, 74.272, 73.200, 71.991, 70.700, 69.393, 68.100, 66.875, 65.700, 64.575, 63.500, 62.460, 61.500, 60.611, 59.900, 59.467, 59.100, 58.716, 58.300, 57.765, 57.200, 56.592, 56.200, 56.140, 56.100, 56.060, 56.000, 55.644, 55.000, 54.125, 53.000, 51.658, 50.200, 48.758, 47.400, 46.175, 45.200, 44.553, 44.100, 43.785, 43.600, 43.549, 43.500, 43.323, 43.100, 42.907, 42.800, 43.000, 43.500},
{6.000, 6.000, 6.000, 6.000, 6.000, 10.607, 18.000, 23.749, 28.400, 31.295, 33.400, 34.966, 36.200, 37.173, 38.100, 39.205, 40.400, 41.700, 43.000, 44.195, 45.300, 46.286, 47.200, 48.211, 48.900, 49.114, 49.200, 48.700, 48.200, 48.227, 48.300, 48.622, 49.200, 49.923, 51.000, 52.954, 55.800, 59.734, 64.500, 69.804, 75.000, 79.447, 83.000, 85.486, 87.200, 88.186, 88.900, 89.531, 90.000, 90.300, 90.500, 90.611, 90.700, 90.808, 90.900, 90.967, 91.000, 91.000, 91.000, 91.000, 91.000, 91.000, 91.000, 91.000, 91.000},
{1.590, 1.590, 1.590, 1.590, 1.590, 4.596, 9.320, 12.710, 15.500, 17.511, 19.000, 20.008, 20.800, 21.434, 22.100, 23.078, 24.300, 25.814, 27.500, 29.187, 30.900, 32.566, 34.300, 36.384, 38.300, 39.875, 40.700, 40.650, 40.600, 40.628, 40.700, 41.029, 41.600, 42.260, 43.200, 44.756, 47.100, 50.946, 56.000, 61.963, 68.100, 73.448, 78.100, 82.048, 85.000, 86.762, 88.000, 88.939, 89.600, 90.008, 90.300, 90.530, 90.700, 90.817, 90.900, 90.950, 91.000, 91.100, 91.200, 91.267, 91.300, 91.300, 91.300, 91.300, 91.300}};

float CC_FILTER[3][65] = {
    { 8.374e-02, 7.198e-02, 6.052e-02, 4.936e-02, 3.848e-02, 2.707e-02,
      1.750e-02, 1.119e-02, 6.607e-03, 3.097e-03, 1.010e-03, 2.911e-04,
     -1.068e-13, 1.577e-04, 5.047e-04, 1.121e-03, 2.022e-03, 3.121e-03,
      4.564e-03, 6.699e-03, 9.176e-03, 1.144e-02, 1.384e-02, 1.653e-02,
      1.960e-02, 2.339e-02, 2.759e-02, 3.179e-02, 3.628e-02, 4.128e-02,
      4.682e-02, 5.302e-02, 5.994e-02, 6.779e-02, 7.647e-02, 8.576e-02,
      9.615e-02, 1.084e-01, 1.221e-01, 1.371e-01, 1.532e-01, 1.705e-01,
      1.884e-01, 2.061e-01, 2.249e-01, 2.474e-01, 2.704e-01, 2.895e-01,
      3.087e-01, 3.320e-01, 3.552e-01, 3.751e-01, 3.922e-01, 4.067e-01,
      4.178e-01, 4.243e-01, 4.299e-01, 4.365e-01, 4.436e-01, 4.516e-01,
      4.593e-01, 4.669e-01, 4.711e-01, 4.686e-01, 4.608e-01},
    {8.347e-02, 7.578e-02, 6.821e-02, 6.078e-02, 5.347e-02, 4.532e-02,
     3.921e-02, 3.634e-02, 3.508e-02, 3.638e-02, 3.921e-02, 4.400e-02,
     5.080e-02, 5.892e-02, 6.877e-02, 8.033e-02, 9.395e-02, 1.103e-01,
     1.289e-01, 1.491e-01, 1.711e-01, 1.951e-01, 2.211e-01, 2.493e-01,
     2.793e-01, 3.107e-01, 3.423e-01, 3.724e-01, 4.015e-01, 4.318e-01,
     4.576e-01, 4.753e-01, 4.872e-01, 4.943e-01, 4.975e-01, 4.949e-01,
     4.887e-01, 4.749e-01, 4.522e-01, 4.158e-01, 3.704e-01, 3.225e-01,
     2.739e-01, 2.272e-01, 1.840e-01, 1.453e-01, 1.120e-01, 8.449e-02,
     6.270e-02, 4.667e-02, 3.456e-02, 2.578e-02, 1.892e-02, 1.285e-02,
     8.629e-03, 6.558e-03, 5.253e-03, 4.461e-03, 3.814e-03, 3.096e-03,
     2.380e-03, 1.629e-03, 9.503e-04, 4.214e-04, 0.000e+00},
    {3.321e-01, 3.530e-01, 3.750e-01, 3.982e-01, 4.227e-01, 4.516e-01,
     4.762e-01, 4.901e-01, 4.981e-01, 5.013e-01, 5.026e-01, 4.987e-01,
     4.906e-01, 4.791e-01, 4.622e-01, 4.356e-01, 4.018e-01, 3.640e-01,
     3.220e-01, 2.743e-01, 2.281e-01, 1.900e-01, 1.543e-01, 1.163e-01,
     8.252e-02, 5.538e-02, 3.516e-02, 2.170e-02, 1.353e-02, 1.013e-02,
     8.163e-03, 7.047e-03, 6.228e-03, 5.479e-03, 4.783e-03, 3.972e-03,
     3.343e-03, 3.013e-03, 2.863e-03, 2.863e-03, 2.863e-03, 2.624e-03,
     2.385e-03, 2.385e-03, 2.385e-03, 2.146e-03, 1.907e-03, 1.907e-03,
     1.907e-03, 1.668e-03, 1.429e-03, 1.429e-03, 1.429e-03, 1.191e-03,
     9.524e-04, 9.524e-04, 9.524e-04, 7.141e-04, 4.759e-04, 4.759e-04,
     4.759e-04, 2.379e-04, 6.939e-18, 9.714e-17, 6.939e-18}
};

float CC_FILTERS[3][7][65] = {
    {
        {100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0},
        {85.500, 85.950, 86.400, 86.850, 87.300, 87.782, 88.200, 88.483, 88.700,
         88.859, 89.000, 89.157, 89.300, 89.413, 89.500, 89.554, 89.600, 89.663,
         89.700, 89.700, 89.700, 89.700, 89.700, 89.650, 89.600, 89.600, 89.600,
         89.562, 89.500, 89.454, 89.400, 89.313, 89.200, 89.063, 88.900, 88.713,
         88.500, 88.257, 88.000, 87.750, 87.500, 87.256, 87.000, 86.722, 86.400,
         85.978, 85.500, 84.985, 84.500, 84.120, 83.800, 83.540, 83.300, 83.034,
         82.800, 82.622, 82.500, 82.451, 82.400, 82.180, 82.000, 82.000, 82.000,
         82.156, 82.500},
        {83.000, 83.750, 84.500, 85.250, 86.000, 86.830, 87.500, 87.839, 88.100,
         88.363, 88.600, 88.836, 89.000, 89.070, 89.100, 89.100, 89.100, 89.050,
         89.000, 89.000, 89.000, 89.000, 89.000, 89.000, 89.000, 88.880, 88.700,
         88.606, 88.500, 88.277, 88.000, 87.750, 87.500, 87.268, 87.000, 86.593,
         86.100, 85.570, 85.000, 84.413, 83.800, 83.168, 82.500, 81.763, 81.000,
         80.256, 79.500, 78.706, 77.900, 77.071, 76.300, 75.639, 75.100, 74.703,
         74.400, 74.186, 74.000, 73.810, 73.600, 73.277, 73.000, 72.862, 72.800,
         73.162, 74.000},
        {81.300, 81.950, 82.600, 83.250, 83.900, 84.550, 85.200, 85.871, 86.500,
         87.100, 87.500, 87.625, 87.700, 87.767, 87.800, 87.767, 87.700, 87.613,
         87.500, 87.350, 87.200, 87.106, 87.000, 86.777, 86.500, 86.264, 86.000,
         85.629, 85.200, 84.757, 84.300, 83.861, 83.400, 82.897, 82.300, 81.466,
         80.500, 79.536, 78.500, 77.314, 76.100, 75.016, 73.900, 72.584, 71.200,
         69.868, 68.500, 67.007, 65.500, 64.021, 62.700, 61.660, 60.800, 60.098,
         59.500, 58.952, 58.500, 58.166, 57.900, 57.660, 57.500, 57.430, 57.400,
         57.737, 58.500},
        {77.900, 79.000, 80.100, 81.200, 82.300, 83.452, 84.500, 85.323, 86.000,
         86.592, 87.000, 87.178, 87.300, 87.430, 87.500, 87.430, 87.300, 87.167,
         87.000, 86.766, 86.500, 86.264, 86.000, 85.623, 85.200, 84.806, 84.400,
         83.968, 83.500, 82.980, 82.400, 81.752, 81.000, 80.062, 79.000, 77.893,
         76.700, 75.400, 74.000, 72.495, 70.900, 69.220, 67.500, 65.818, 64.100,
         62.270, 60.400, 58.544, 56.700, 54.830, 53.100, 51.615, 50.400, 49.482,
         48.800, 48.367, 48.000, 47.620, 47.200, 46.568, 46.000, 45.662, 45.500,
         45.750, 46.400},
        {74.400, 75.900, 77.400, 78.900, 80.400, 81.984, 83.400, 84.477, 85.300,
         85.906, 86.300, 86.508, 86.600, 86.600, 86.600, 86.537, 86.400, 86.131,
         85.800, 85.562, 85.300, 84.882, 84.400, 83.961, 83.500, 82.975, 82.400,
         81.775, 81.100, 80.385, 79.600, 78.706, 77.700, 76.547, 75.300, 74.056,
         72.700, 71.086, 69.300, 67.377, 65.400, 63.506, 61.600, 59.625, 57.600,
         55.513, 53.400, 51.300, 49.200, 47.013, 45.000, 43.344, 42.000, 40.957,
         40.200, 39.762, 39.400, 39.016, 38.600, 38.050, 37.500, 36.984, 36.700,
         36.837, 37.300},
        {71.000, 72.950, 74.900, 76.850, 78.800, 80.896, 82.700, 83.911, 84.800,
         85.488, 85.900, 86.042, 86.100, 86.069, 86.000, 85.878, 85.700, 85.483,
         85.200, 84.782, 84.300, 83.861, 83.400, 82.885, 82.300, 81.585, 80.800,
         80.024, 79.200, 78.293, 77.300, 76.206, 75.000, 73.658, 72.200, 70.671,
         69.000, 67.085, 65.000, 62.795, 60.500, 58.150, 55.800, 53.573, 51.300,
         48.705, 46.200, 44.209, 42.300, 40.089, 38.000, 36.304, 34.900, 33.751,
         32.900, 32.413, 32.000, 31.513, 31.000, 30.435, 29.900, 29.384, 29.100,
         29.269, 29.800}
    },
    {
        {100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0},
        {86.400, 86.700, 87.000, 87.300, 87.600, 87.915, 88.200, 88.440, 88.600,
         88.670, 88.700, 88.700, 88.700, 88.667, 88.600, 88.521, 88.400, 88.148,
         87.800, 87.425, 87.000, 86.514, 86.000, 85.511, 85.000, 84.407, 83.800,
         83.230, 82.700, 82.207, 81.800, 81.490, 81.300, 81.229, 81.200, 81.292,
         81.500, 81.908, 82.500, 83.195, 84.000, 84.857, 85.800, 86.943, 88.000,
         88.721, 89.300, 89.814, 90.200, 90.436, 90.600, 90.708, 90.800, 90.908,
         91.000, 91.054, 91.100, 91.150, 91.200, 91.250, 91.300, 91.350, 91.400,
         91.450, 91.500},
        {84.400, 84.950, 85.500, 86.050, 86.600, 87.229, 87.700, 87.909, 88.000,
         88.000, 88.000, 87.970, 87.900, 87.751, 87.500, 87.070, 86.500, 85.888,
         85.200, 84.432, 83.600, 82.731, 81.800, 80.776, 79.700, 78.606, 77.500,
         76.357, 75.300, 74.440, 73.700, 72.989, 72.500, 72.290, 72.200, 72.388,
         72.800, 73.543, 74.600, 75.839, 77.300, 78.981, 80.800, 82.727, 84.500,
         85.853, 87.000, 88.046, 88.900, 89.538, 90.000, 90.300, 90.500, 90.606,
         90.700, 90.850, 91.000, 91.113, 91.200, 91.254, 91.300, 91.350, 91.400,
         91.450, 91.500},
        {83.600, 84.100, 84.600, 85.100, 85.600, 86.154, 86.600, 86.871, 87.000,
         86.972, 86.900, 86.551, 86.000, 85.497, 84.900, 84.082, 83.100, 82.018,
         80.800, 79.426, 77.900, 76.215, 74.400, 72.470, 70.500, 68.560, 66.700,
         64.994, 63.400, 61.851, 60.500, 59.377, 58.600, 58.186, 58.000, 58.084,
         58.300, 59.099, 60.500, 62.446, 64.900, 67.612, 70.600, 73.895, 77.100,
         79.812, 82.200, 84.312, 86.100, 87.573, 88.700, 89.476, 90.000, 90.293,
         90.500, 90.667, 90.800, 90.905, 91.000, 91.100, 91.200, 91.308, 91.400,
         91.460, 91.500},
        {81.200, 81.950, 82.700, 83.450, 84.200, 85.093, 85.700, 85.844, 85.900,
         85.806, 85.600, 85.246, 84.700, 83.880, 82.800, 81.511, 80.000, 78.296,
         76.400, 74.343, 72.100, 69.617, 67.000, 64.356, 61.700, 59.047, 56.500,
         54.131, 52.000, 50.131, 48.600, 47.401, 46.600, 46.185, 46.000, 46.141,
         46.500, 47.733, 49.800, 52.399, 55.600, 59.278, 63.300, 67.457, 71.600,
         75.647, 79.200, 81.902, 84.100, 85.942, 87.400, 88.499, 89.300, 89.813,
         90.200, 90.552, 90.800, 90.921, 91.000, 91.050, 91.100, 91.192, 91.300,
         91.400, 91.500},
        {77.700, 78.850, 80.000, 81.150, 82.300, 83.619, 84.600, 85.019, 85.200,
         84.941, 84.400, 83.579, 82.500, 81.361, 80.000, 78.207, 76.100, 73.803,
         71.300, 68.615, 65.800, 62.949, 60.000, 56.863, 53.700, 50.606, 47.700,
         45.111, 42.800, 40.723, 39.000, 37.626, 36.700, 36.216, 36.000, 36.204,
         36.700, 38.043, 40.200, 42.865, 46.200, 50.275, 54.900, 59.813, 64.900,
         70.165, 74.900, 78.461, 81.400, 83.948, 86.000, 87.556, 88.700, 89.493,
         90.000, 90.234, 90.400, 90.555, 90.700, 90.850, 91.000, 91.157, 91.300,
         91.411, 91.500},
        {75.500, 76.850, 78.200, 79.550, 80.900, 82.433, 83.600, 84.154, 84.400,
         84.147, 83.600, 82.683, 81.400, 79.891, 78.100, 76.049, 73.700, 70.977,
         68.000, 64.914, 61.700, 58.388, 55.000, 51.537, 48.100, 44.743, 41.600,
         38.821, 36.300, 33.854, 31.900, 30.626, 29.800, 29.319, 29.100, 29.278,
         29.700, 30.654, 32.300, 35.128, 39.000, 43.541, 48.700, 54.225, 59.900,
         65.485, 70.700, 75.323, 79.200, 82.177, 84.500, 86.226, 87.600, 88.832,
         89.700, 90.129, 90.400, 90.565, 90.700, 90.850, 91.000, 91.157, 91.300,
         91.411, 91.500}
    },
    {
        {100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0,
         100.0, 100.0, 100.0, 100.0, 100.0},
        {81.800, 81.600, 81.400, 81.200, 81.000, 80.783, 80.600, 80.467, 80.400,
         80.400, 80.400, 80.463, 80.600, 80.835, 81.200, 81.784, 82.500, 83.194,
         83.900, 84.583, 85.300, 86.150, 87.000, 87.738, 88.400, 89.018, 89.500,
         89.780, 90.000, 90.213, 90.400, 90.563, 90.700, 90.813, 90.900, 90.948,
         91.000, 91.150, 91.300, 91.369, 91.400, 91.400, 91.400, 91.400, 91.400,
         91.400, 91.400, 91.400, 91.400, 91.450, 91.500, 91.500, 91.500, 91.500,
         91.500, 91.500, 91.500, 91.500, 91.500, 91.500, 91.500, 91.500, 91.500,
         91.500, 91.500},
        {77.100, 76.450, 75.800, 75.150, 74.500, 73.790, 73.200, 72.819, 72.600,
         72.529, 72.500, 72.590, 72.800, 73.273, 74.000, 74.910, 76.000, 77.203,
         78.500, 79.808, 81.200, 82.793, 84.400, 85.899, 87.200, 88.213, 89.000,
         89.589, 90.000, 90.229, 90.400, 90.563, 90.700, 90.813, 90.900, 90.948,
         91.000, 91.150, 91.300, 91.369, 91.400, 91.400, 91.400, 91.400, 91.400,
         91.400, 91.400, 91.400, 91.400, 91.450, 91.500, 91.500, 91.500, 91.500,
         91.500, 91.500, 91.500, 91.500, 91.500, 91.500, 91.500, 91.500, 91.500,
         91.500, 91.500},
        {65.900, 64.750, 63.600, 62.450, 61.300, 60.060, 59.000, 58.263, 57.800,
         57.590, 57.500, 57.586, 57.800, 58.428, 59.500, 61.044, 63.000, 65.162,
         67.500, 69.829, 72.300, 75.071, 78.000, 81.131, 84.000, 86.314, 88.000,
         89.006, 89.600, 89.820, 90.000, 90.323, 90.600, 90.721, 90.800, 90.854,
         90.900, 90.950, 91.000, 91.050, 91.100, 91.150, 91.200, 91.262, 91.300,
         91.300, 91.300, 91.300, 91.300, 91.350, 91.400, 91.400, 91.400, 91.400,
         91.400, 91.400, 91.400, 91.400, 91.400, 91.400, 91.400, 91.400, 91.400,
         91.400, 91.400},
        {56.700, 55.150, 53.600, 52.050, 50.500, 48.804, 47.400, 46.537, 46.000,
         45.722, 45.600, 45.895, 46.500, 47.322, 48.500, 50.246, 52.500, 55.168,
         58.200, 61.435, 64.900, 68.533, 72.400, 76.854, 81.000, 84.216, 86.600,
         88.161, 89.100, 89.440, 89.700, 90.092, 90.400, 90.514, 90.600, 90.708,
         90.800, 90.854, 90.900, 90.950, 91.000, 91.050, 91.100, 91.163, 91.200,
         91.200, 91.200, 91.200, 91.200, 91.250, 91.300, 91.300, 91.300, 91.300,
         91.300, 91.300, 91.300, 91.350, 91.400, 91.400, 91.400, 91.400, 91.400,
         91.400, 91.400},
        {50.000, 48.250, 46.500, 44.750, 43.000, 41.131, 39.500, 38.348, 37.500,
         36.833, 36.500, 36.586, 36.800, 37.416, 38.500, 40.187, 42.500, 45.411,
         48.800, 52.297, 56.200, 60.858, 66.000, 71.597, 77.000, 81.829, 85.500,
         87.691, 89.000, 89.573, 89.900, 90.076, 90.200, 90.300, 90.400, 90.561,
         90.700, 90.769, 90.800, 90.800, 90.800, 90.850, 90.900, 90.900, 90.900,
         90.900, 90.900, 90.950, 91.000, 91.000, 91.000, 91.000, 91.000, 91.050,
         91.100, 91.100, 91.100, 91.150, 91.200, 91.200, 91.200, 91.250, 91.300,
         91.300, 91.300},
        {42.500, 40.500, 38.500, 36.500, 34.500, 32.273, 30.500, 29.540, 29.000,
         28.787, 28.700, 28.957, 29.500, 30.292, 31.500, 33.486, 36.200, 39.488,
         43.500, 48.546, 54.000, 58.943, 64.000, 69.849, 75.500, 80.369, 84.200,
         86.850, 88.500, 89.196, 89.600, 89.830, 90.000, 90.155, 90.300, 90.469,
         90.600, 90.669, 90.700, 90.700, 90.700, 90.750, 90.800, 90.800, 90.800,
         90.850, 90.900, 90.900, 90.900, 90.950, 91.000, 91.000, 91.000, 91.050,
         91.100, 91.100, 91.100, 91.150, 91.200, 91.200, 91.200, 91.250, 91.300,
         91.300, 91.300}
    }
};

const float D_S0[65] = {63.40, 64.60, 65.80, 80.30, 94.80, 99.80, 104.80, 105.35, 105.90, 101.35, 96.80, 105.35, 113.90, 119.75, 125.60, 125.55, 125.50, 123.40, 121.30, 121.30, 121.30, 117.40, 113.50, 113.30, 113.10, 111.95, 110.80, 108.65, 106.50, 107.65, 108.80, 107.05, 105.30, 104.85, 104.40, 102.20, 100.00, 98.00, 96.00, 95.55, 95.10, 92.10, 89.10, 89.80, 90.50, 90.40, 90.30, 89.35, 88.40, 86.20, 84.00, 84.55, 85.10, 83.50, 81.90, 82.25, 82.60, 83.75, 84.90, 83.10, 81.30, 76.60, 71.90, 73.10, 74.30};

const float D_S1[65] = {38.50, 36.75, 35.00, 39.20, 43.40, 44.85, 46.30, 45.10, 43.90, 40.50, 37.10, 36.90, 36.70, 36.30, 35.90, 34.25, 32.60, 30.25, 27.90, 26.10, 24.30, 22.20, 20.10, 18.15, 16.20, 14.70, 13.20, 10.90, 8.60, 7.35, 6.10, 5.15, 4.20, 3.05, 1.90, 0.95, 0.00, -0.80, -1.60, -2.55, -3.50, -3.50, -3.50, -4.65, -5.80, -6.50, -7.20, -7.90, -8.60, -9.05, -9.50, -10.20, -10.90, -10.80, -10.70, -11.35, -12.00, -13.00, -14.00, -13.80, -13.60, -12.80, -12.00, -12.65, -13.30};

const float D_S2[65] = {3.00, 2.10, 1.20, 0.05, -1.10, -0.80, -0.50, -0.60, -0.70, -0.95, -1.20, -1.90, -2.60, -2.75, -2.90, -2.85, -2.80, -2.70, -2.60, -2.60, -2.60, -2.20, -1.80, -1.65, -1.50, -1.40, -1.30, -1.25, -1.20, -1.10, -1.00, -0.75, -0.50, -0.40, -0.30, -0.15, 0.00, 0.10, 0.20, 0.35, 0.50, 1.30, 2.10, 2.65, 3.20, 3.65, 4.10, 4.40, 4.70, 4.90, 5.10, 5.90, 6.70, 7.00, 7.30, 7.95, 8.60, 9.20, 9.80, 10.00, 10.20, 9.25, 8.30, 8.95, 9.60};

struct di_params {
    float m1;
    float m2;
};

struct di_params calc_di_params(float t)
{
    float x = 0;
    float s = 1000.0f / t;
    if (t <= 7000.0f) {
        x = (((-4.607f * s) + 2.9678f) * s + 0.09911f) * s + 0.244063f;
    } else {
        x = (((-2.0064f * s) + 1.9018f) * s + 0.24748f) * s + 0.237040f;
    }
    float y = (-3.0f * x + 2.870f) * x - 0.275f;
    float m = 0.0241f + 0.2562f * x - 0.7341f * y;

    struct di_params p;
    p.m1 = (-1.3515f - 1.7703f * x + 5.9114f * y) / m;
    p.m2 = (0.030f - 31.4424f * x + 30.0717f * y) / m;
    return p;
}

float daylight_illuminant(struct di_params p, int i)
{
    return D_S0[i] + p.m1 * D_S1[i] + p.m2 * D_S2[i];
}

const int SPECTRUM_SIZE = 65;
const float SPECTRUM_BASE = 380.0;
const float SPECTRUM_STEP = 5.0;

struct Extra
{
    float psr;
    float psg;
    float psb;
    float linear_amp;

    float cy;
    float cm;
    float my;

    int stop;
    int data;

    int pixel;
};

struct SplineS
{
    float a, b, c, d, x;
};

struct CharacteristicCurve
{
    int nodes_cnt;
    float tangent;
    float max;
    float min;
    float bias;
    float smoothness;

    struct SplineS spline[30];
};

struct Illuminant
{
    float v[SPECTRUM_SIZE];
};

struct SpectralSensitivity
{
    float v[SPECTRUM_SIZE];
};

struct SpectralDyeDensity
{
    float v[SPECTRUM_SIZE];
};

struct MaterialLayer
{
    struct CharacteristicCurve curve;
    struct SpectralSensitivity sense;
    struct SpectralDyeDensity dye;
    float couplers[3];
    float amp;
    float theta;
};

struct Fog
{
    float v[SPECTRUM_SIZE];
};

struct PhotoMaterial
{
    struct Fog fog;
    struct MaterialLayer red;
    struct MaterialLayer green;
    struct MaterialLayer blue;
};

struct PhotoProcessOpts
{
    struct Illuminant illuminant1;
    struct Illuminant illuminant2;

    struct PhotoMaterial film;
    struct PhotoMaterial paper;

    struct Extra extra;

    float exposure_correction_film;
    float exposure_correction_paper;
};

float4 xyz_to_linear_srgb_scalar(float4 c)
{
    float x = c.x / 100.0f;
    float y = c.y / 100.0f;
    float z = c.z / 100.0f;

    float r = x *  3.2406f + y * -1.5372f + z * -0.4986f;
    float g = x * -0.9689f + y *  1.8758f + z *  0.0415f;
    float b = x *  0.0557f + y * -0.2040f + z *  1.0570f;
    
    return (float4) (r, g, b, 0.0f);
}

float4 xyz_to_ciergb_scalar(float4 c)
{
    float x = c.x / 100.0f;
    float y = c.y / 100.0f;
    float z = c.z / 100.0f;
    
    return (float4) (
        0.41847f * x - 0.15866f * y - 0.082835f * z,
        -0.091169f * x + 0.25243f * y + 0.015708f * z,
        0.00092090f * x - 0.0025498f * y + 0.17860f * z,
        0.0f
    );
}

/*
 * Film common
 */

float log_density(
    float x,
    float exposure_correction,
    struct CharacteristicCurve * c
    )
{
    if (c->nodes_cnt == 0) {
        float a = (c->max - c->min) / 2;
        float y = c->tangent * (x + c->bias + exposure_correction) / a;
        float w = y / pow(1 + pow(fabs(y), 1 / c->smoothness), c->smoothness);
        return a * (w + 1); // + c->min;
    } else {
        x += exposure_correction;
        for (int i = c->nodes_cnt - 1; i >= 0; i--) {
            struct SplineS ss = c->spline[i];
            if (x >= ss.x) {
                float dx = x - ss.x;
                return ((ss.d * dx + ss.c) * dx + ss.b) * dx + ss.a;
            }
        }
        return c->spline[0].a;
    }
}

float4 fix_exposure(float4 e)
{
    float m = 1.0e-20;
    if(e.x < m)
        e.x = m;
    if(e.y < m)
        e.y = m;
    if(e.z < m)
        e.z = m;
    return e;
}


float residual_dye(float density)
{
    //return pow(10.0, -1.0 * density);
    float r = 1 - density / 3;
    if (r < 0) {
        return 0;
    }
    return r;
}

float4 dye_absorbtion(int i, float4 density, struct PhotoProcessOpts * opts)
{
    float R = opts->film.red.dye.v[i];
    float G = opts->film.green.dye.v[i];
    float B = opts->film.blue.dye.v[i];

    return (float4) (
        R * density.x
            + (opts->extra.cy * B + opts->extra.cm * G) * residual_dye(density.x),
        G * density.y
            + opts->extra.my * B * residual_dye(density.y),
        B * density.z,
        opts->film.fog.v[i]
    );
}

float4 rgb_to_exposure(float4 rgb, struct PhotoProcessOpts * opts)
{
    struct di_params p = calc_di_params(5500.0f);
    float4 exposure = (float4) (0, 0, 0, 0);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        //printf("di: %f ", di);
        /*
        float spectrum = rgb.x * E1931_78[i][0]
                       + rgb.y * E1931_78[i][1]
                       + rgb.z * E1931_78[i][2];
        */
        float spectrum = rgb.x * RHO[0][i]
                       + rgb.y * RHO[1][i]
                       + rgb.z * RHO[2][i];
        if (spectrum < 0) {
            spectrum = 0;
        }

        //float di = daylight_illuminant(p, i);
        //spectrum *= di / 100.0f;

        if (opts->extra.data >= 0) { 
            spectrum *= FILTERS[opts->extra.data][i] / 100.0;
        }
        
        /*
        spectrum *= pow(10.0f,
                 CC_FILTER[0][i]*opts->extra.psr
               + CC_FILTER[1][i]*opts->extra.psg
               + CC_FILTER[2][i]*opts->extra.psb);
        */
        /*
        spectrum *= pow(10.0f,
                ((i >= 0  && i < 26) ? 1.0f : 0.0f) * opts->extra.psb +
                ((i >= 26 && i < 40) ? 1.0f : 0.0f) * opts->extra.psg +
                ((i >= 40 && i < 65) ? 1.0f : 0.0f) * opts->extra.psr);
        */

        exposure.x += spectrum * (opts->film.red.sense.v[i] / pow(10, opts->film.red.theta));
        exposure.y += spectrum * (opts->film.green.sense.v[i] / pow(10, opts->film.green.theta));
        exposure.z += spectrum * (opts->film.blue.sense.v[i] / pow(10, opts->film.blue.theta));
    }

    return fix_exposure(exposure);
}

float rgb_to_exposure_scalar(float4 rgb, struct SpectralSensitivity * sense)
{
    float exposure = 0.0;
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float spectrum = rgb.x * RHO[0][i]
                       + rgb.y * RHO[1][i]
                       + rgb.z * RHO[2][i];
        if (spectrum < 0) {
            spectrum = 0;
        }
        exposure += spectrum * sense->v[i];
    }
    
    if (exposure < 1e-20) {
        exposure = 1e-20;
    }
    return exposure;
}

float4 exposure_to_density(
    float4 exposure,
    struct PhotoProcessOpts * opts,
    float k,
    float exp_corr
    )
{
    float4 density = (float4) (
        log_density(k * (log10(exposure.x)/* - opts->film.red.theta*//*0.75f*/),
            opts->exposure_correction_film + exp_corr,
            &opts->film.red.curve),
        log_density(k * (log10(exposure.y)/* - opts->film.green.theta*//*0.58f*/),
            opts->exposure_correction_film + exp_corr,
            &opts->film.green.curve),
        log_density(k * (log10(exposure.z)/* - opts->film.blue.theta*//*0.63f*/),
            opts->exposure_correction_film + exp_corr,
            &opts->film.blue.curve),
        0
    );
    return density;
}

float4 exposure_to_density_paper(
    float4 exposure,
    struct PhotoProcessOpts * opts,
    float k
    )
{
    float4 density = (float4) (
        log_density(k * log10(exposure.x),
            opts->exposure_correction_paper,
            &opts->paper.red.curve),
        log_density(k * log10(exposure.y),
            opts->exposure_correction_paper,
            &opts->paper.green.curve),
        log_density(k * log10(exposure.z),
            opts->exposure_correction_paper,
            &opts->paper.blue.curve),
        0
    );
    return density;
}

float exposure_to_density_paper_component(
    float exposure,
    struct CharacteristicCurve * curve,
    float k
    )
{
    return log_density(k * log10(exposure), 0, curve);
}

/*
 * Densitometry
 */
float4 densitometry(float4 density, struct PhotoProcessOpts * opts)
{
    float4 L = (float4) (0, 0, 0, 0);
    float4 l = (float4) (0, 0, 0, 0);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float4 M = (float4) (STATUS_M[0][i], STATUS_M[1][i], STATUS_M[2][i], 0);
        float4 Mp = pow(10.0f, M);
        L += Mp; 
        float4 da = dye_absorbtion(i, density, opts);
        l += Mp / pow(10.0f, da.x + da.y + da.z + da.w);
    }
    return log10((float4) (L.x / l.x, L.y / l.y, L.z / l.z, 0));
}

__kernel void densitometry_status_M (
    __global float4 * log_exposures,
    __global float4 * densities,
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);
    float4 ec = (float4) (opts->film.red.curve.bias, opts->film.green.curve.bias, opts->film.blue.curve.bias, 0);
    float4 exposure = (float4) (0, 0, 0, 0);
    float4 e = pow(10.0f, log_exposures[idx]); //- opts->exposure_correction_film);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float4 spectrum = CIE_A[i] * e;
        exposure.x += spectrum.x * opts->film.red.sense.v[i];
        exposure.y += spectrum.y * opts->film.green.sense.v[i];
        exposure.z += spectrum.z * opts->film.blue.sense.v[i];
    }
    float4 d = exposure_to_density(exposure, opts, 1.0f, 0);
    densities[idx] = densitometry(d, opts);
}

__kernel void spectral_density_measurements(
    __global float * spectra, // array [n][65]
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);
    
    float v = idx * 0.01;
    printf("v = %f\n", v);

    float4 px = (float4)(v, v, v, 0);
    printf("px = %2.2v4hlf\n", px);
    
    float4 xyz = srgb_to_xyz_scalar(px);
    float4 lrgb = xyz_to_linear_srgb_scalar(px);
    printf("rgb = %2.2v4hlf\n", lrgb);
    float4 exposure = rgb_to_exposure(lrgb, opts);

    printf("e = %2.2v4hlf\n", exposure);

    float4 density = exposure_to_density(exposure, opts, 1.0f, 0);
    printf("d = %v4f\n", density);
    
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float4 da = dye_absorbtion(i, density, opts);
        spectra[idx * SPECTRUM_SIZE + i] = da.x + da.y + da.z + da.w;
    } 
}

float nneg(float x)
{
    if (x < 0.0f) {
        return 0.0f;
    }
    return x;
}

/*
 * 1. Image XYZ -> Spectrum
 * 2. Spectrum, <<Spectral sensitivity (film)>> -> Exposure
 * 3. Exposure, <<Characteristic curve (film)>>,
 *      <<Exposure correction (film)>> -> Density (film)
 * 4. Density (film), <<Spectral duffuse dye density (film)>>,
 *      <<Illuminant 1>> -> Duffused spectrum
 * 5. Duffused spectrum, <<Spectral sensitivity (paper)>> -> Exposure
 * 6. Exposure, <<Characteristic curve (paper)>>,
 *      <<Exposure correction (paper)>> -> Density (paper)
 * 7. Density (paper), <<Spectral reflection dye density (paper)>>,
 *      <<Illuminant 2>> -> Reflected spectrum
 * 8. Reflected spectrum -> XYZ -> sRGB
 *
 * Parameters:
 *  - Illuminants
 *  - Photographic materials:
 *      - Characteristic curve
 *      - Spectral sensitivity
 *      - Spectral dye density
 *  - Other:
 *      - Exposure correction
 */

__kernel void process_photo(
    __global float4 * img,
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);
    int es = opts->extra.stop;
    
    float4 px = (idx == 0) ? srgb_to_xyz_scalar((float4)(0.01f, 0.01f, 0.01f, 0.0f))
                           : img[idx];
    float4 lrgb = xyz_to_linear_srgb_scalar(px);
    //lrgb = pow(lrgb, 0.8f);
    float4 exposure = rgb_to_exposure(lrgb, opts);

    float4 density = exposure_to_density(exposure, opts, 1.0f, 0);

#if 1
    density.x *= exp(-0.25f * density.x);
    density.y *= exp(-0.25f * density.y);
    density.z *= exp(-0.25f * density.z);
#endif

    float4 density2 = exposure_to_density(exposure, opts, 1.0f, 1.2f);
    //float L = 0.0f;
    exposure = (float4)(0, 0, 0, 0);
    float4 xyz = (float4)(0, 0, 0, 0);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant1.v[i];
        float rr = opts->film.red.dye.v[i];
        float gg = opts->film.green.dye.v[i];
        float bb = opts->film.blue.dye.v[i];

        float cr = opts->film.red.couplers[0] * (
                   density.x
                 + (1-density.y) * opts->film.red.couplers[1]
                 + (1-density.z) * opts->film.red.couplers[2]);
        
        float cg = opts->film.red.couplers[0] * (
                   (1-density.x) * opts->film.green.couplers[0]
                 + density.y 
                 + (1-density.z) * opts->film.green.couplers[2]);

        float cb = opts->film.red.couplers[0] * (
                   (1-density.x) * opts->film.blue.couplers[0]
                 + (1-density.y) * opts->film.blue.couplers[1]
                 + density.z);

#if 1
   
        float cr2 = opts->film.red.couplers[0] * (
                    density2.x
                 + (1-density2.y) * opts->film.red.couplers[1]
                 + (1-density2.z) * opts->film.red.couplers[2]);
        
        float cg2 = opts->film.red.couplers[0] * (
                  (1-density2.x) * opts->film.green.couplers[0]
                 + density2.y
                 + (1-density2.z) * opts->film.green.couplers[2]);

        float cb2 = opts->film.red.couplers[0] * (
                   (1-density2.x) * opts->film.blue.couplers[0]
                 + (1-density2.y) * opts->film.blue.couplers[1]
                 + density2.z);
#else
        float cr2 = cr;
        float cg2 = cg;
        float cb2 = cb;
#endif
        if (cr < 0) { cr = 0; }
        if (cg < 0) { cg = 0; }
        if (cb < 0) { cb = 0; }
        if (cr2 < 0) { cr2 = 0; }
        if (cg2 < 0) { cg2 = 0; }
        if (cb2 < 0) { cb2 = 0; }

        float j = 0.7f;
        float rrr = rr*(j*cr + (1-j)*cr2);
        float ggg = gg*(j*cg + (1-j)*cg2);
        float bbb = bb*(j*cb + (1-j)*cb2);
        lt /= pow(10.0f, rrr + ggg + bbb); 
        /*
           + CC_FILTER[0][i]*opts->extra.psr
           + CC_FILTER[1][i]*opts->extra.psg
           + CC_FILTER[2][i]*opts->extra.psb);
        */
        lt /= pow(10.0f,
                ((i >= 0  && i < 26) ? 1.0f : 0.0f) * opts->extra.psb +
                ((i >= 26 && i < 40) ? 1.0f : 0.0f) * opts->extra.psg +
                ((i >= 40 && i < 65) ? 1.0f : 0.0f) * opts->extra.psr);

        if (!opts->extra.stop) {
            exposure.x += lt * opts->paper.red.sense.v[i];
            exposure.y += lt * opts->paper.green.sense.v[i];
            exposure.z += lt * opts->paper.blue.sense.v[i];
        } else {
            xyz.x += lt * A1931_78[i][0];
            xyz.y += lt * A1931_78[i][1];
            xyz.z += lt * A1931_78[i][2];
        }
    }
    if (opts->extra.stop) {
        float4 c = xyz_to_srgb_scalar(xyz / 3000.0f * opts->extra.linear_amp);
        img[idx] = c;
        return;
    }
    /*
    if (log10(exposure.x + exposure.y + exposure.z) > 1.0f) {
        exposure.w = 1.0f;
    } else {
        exposure.w = 0.0f;
    }
    img[idx] = exposure;
    */
    density = exposure_to_density_paper(exposure, opts, 1.0f);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant2.v[i];
        float rr = opts->paper.red.dye.v[i];
        float gg = opts->paper.green.dye.v[i];
        float bb = opts->paper.blue.dye.v[i];

        //lt /= pow(10.0f, 1.0f * (rr * density.x + gg * density.y + bb * density.z));

        float cr = opts->paper.red.couplers[0] * (
                    density.x
                 + (1-density.y) * opts->paper.red.couplers[1]
                 + (1-density.z) * opts->paper.red.couplers[2]);
        float cg = opts->paper.red.couplers[0] * (
                   (1-density.x) * opts->paper.green.couplers[0]
                 + density.y
                 + (1-density.z) * opts->paper.green.couplers[2]);
        float cb = opts->paper.red.couplers[0] * (
                   (1-density.x) * opts->paper.blue.couplers[0]
                 + (1-density.y) * opts->paper.blue.couplers[1]
                 + density.z);
        if (cr < 0) { cr = 0; }
        if (cg < 0) { cg = 0; }
        if (cb < 0) { cb = 0; }

        float rrr = rr*cr;
        float ggg = gg*cg;
        float bbb = bb*cb;
        lt /= pow(10.0f, rrr + ggg + bbb);

        if (opts->extra.pixel == idx) {
            printf("%f\n", lt);
        }

        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }
    /*
    if(idx == 0 || idx == 500000) {
        printf("exposure: (%f, %f, %f)\n", exposure.x, exposure.y, exposure.z);
        printf("density: (%f, %f, %f)\n", density.x, density.y, density.z);
        //printf("L = %f\n", L);
    }
    */
    float4 c = xyz_to_srgb_scalar(xyz / 3000.0f * opts->extra.linear_amp);
    if (opts->extra.pixel == idx) {
        printf("\npixel: %.2f %.2f %.2f\n", c.x, c.y, c.z);
    }
    /*
    if (idx == 0) {
        printf("srgb result for gray: %.2f %.2f %.2f\n", c.x, c.y, c.z);
    }
    */
    img[idx] = c;
    //img[idx] = (float4)(q, q, q, 0);
}

__kernel void process_photo_cont(
    __global float4 * img,
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);
    float4 exposure = img[idx];
    float4 xyz = (float4)(0, 0, 0, 0);
    float q = exposure.w; // / 0.2f;

    exposure *= (1.0f - 0.0f * exposure.w);

    float4 density = exposure_to_density_paper(exposure, opts, 1.0f);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant2.v[i];
        float rr = opts->paper.red.dye.v[i];
        float gg = opts->paper.green.dye.v[i];
        float bb = opts->paper.blue.dye.v[i];

        //lt /= pow(10.0f, 1.0f * (rr * density.x + gg * density.y + bb * density.z));

        float cr = opts->paper.red.couplers[0] * (
                    density.x
                 + (1-density.y) * opts->paper.red.couplers[1]
                 + (1-density.z) * opts->paper.red.couplers[2]);
        float cg = opts->paper.red.couplers[0] * (
                   (1-density.x) * opts->paper.green.couplers[0]
                 + density.y
                 + (1-density.z) * opts->paper.green.couplers[2]);
        float cb = opts->paper.red.couplers[0] * (
                   (1-density.x) * opts->paper.blue.couplers[0]
                 + (1-density.y) * opts->paper.blue.couplers[1]
                 + density.z);
        if (cr < 0) { cr = 0; }
        if (cg < 0) { cg = 0; }
        if (cb < 0) { cb = 0; }

        float rrr = rr*cr;
        float ggg = gg*cg;
        float bbb = bb*cb;
        lt /= pow(10.0f, rrr + ggg + bbb);

        if (opts->extra.pixel == idx) {
            printf("%f\n", lt);
        }

        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }
    /*
    if(idx == 0 || idx == 500000) {
        printf("exposure: (%f, %f, %f)\n", exposure.x, exposure.y, exposure.z);
        printf("density: (%f, %f, %f)\n", density.x, density.y, density.z);
        //printf("L = %f\n", L);
    }
    */
    float4 c = xyz_to_srgb_scalar(xyz / 3000.0f * opts->extra.linear_amp);
    if (opts->extra.pixel == idx) {
        printf("\npixel: %.2f %.2f %.2f\n", c.x, c.y, c.z);
    }
    /*
    if (idx == 0) {
        printf("srgb result for gray: %.2f %.2f %.2f\n", c.x, c.y, c.z);
    }
    */
    img[idx] = c;
    //img[idx] = (float4)(q, q, q, 0);
}

/*
 *  Slide film
 */
__kernel void process_slide(
    __global float4 * img,
    __global struct PhotoProcessOpts * opts
    )
{
    struct di_params di = calc_di_params(6500.0f);
    int idx = get_global_id(0);
    
    float4 px = img[idx];
    float4 lrgb = xyz_to_ciergb_scalar(px);
    float4 exposure = rgb_to_exposure(lrgb, opts);

    float k = 1.0f;
    float4 density = /*2.5f **/ 1.5f * (exposure_to_density(exposure, opts, k, 0));

    float4 xyz = (float4)(0, 0, 0, 0);
    float L = 0.0f;
    float l = 0.0f;
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        //float lt = opts->illuminant1.v[i];
        float lt = daylight_illuminant(di, i);
        L += lt * A1931_78[i][1];
        lt /= pow(10.0f, opts->film.red.dye.v[i]   * density.x);
        lt /= pow(10.0f, opts->film.green.dye.v[i] * density.y);
        lt /= pow(10.0f, opts->film.blue.dye.v[i]  * density.z);
        lt /= pow(10.0f, opts->film.fog.v[i]);
        l += lt;
        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }

    float4 c = xyz_to_srgb_scalar(xyz * 0.05f /*/ L * 150.0f*/);
    img[idx] = c;
}

/*
 *  B&W film
 */
__kernel void process_bw(
    __global float4 * img,
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);
    
    float4 px = img[idx];
    float4 lrgb = xyz_to_linear_srgb_scalar(px);
    float exposure = rgb_to_exposure_scalar(lrgb, &opts->film.red.sense);

    float k = 1.0f;
    float density = 1.0f * log_density(k * log10(exposure),
            k * opts->exposure_correction_film,
            &opts->film.red.curve);
    if (density < 0) {
        img[idx] = (float4) (1, 0, 0, 0);
        return;
    }

    exposure = 0.0f;
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant1.v[i];
        lt /= pow(10.0f, density);
        exposure += lt * opts->paper.red.sense.v[i];
    }

    density = exposure_to_density_paper_component(
        exposure + opts->exposure_correction_paper,
        &opts->paper.red.curve,
        1.0f
    );

    float4 xyz = (float4) (0, 0, 0, 0);

    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant2.v[i];
        lt /= pow(10.0f, density);

        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }

    float4 c = xyz_to_srgb_scalar(xyz / 3000.0f * 100.0f);
    img[idx] = c;
}

/*
float8 density_to_exposure_paper(float4 density, struct PhotoProcessOpts * opts)
{
    float4 exposure = (float4)(0, 0, 0, 0);
    float4 xyz = (float4)(0, 0, 0, 0);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant1.v[i];
        float4 da = dye_absorbtion(i, density, opts);
        lt /= pow(10.0f, da.x + da.y + da.z + da.w);

        exposure.x += lt * opts->paper.red.sense.v[i] * opts->extra.psr;
        exposure.y += lt * opts->paper.green.sense.v[i] * opts->extra.psg;
        exposure.z += lt * opts->paper.blue.sense.v[i] * opts->extra.psb;
        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }

    exposure = fix_exposure(exposure);

    return (float8) (exposure, xyz);
}

__kernel void process_photo(
    __global float4 * img,
    __global float4 * img_dbg,
    __global float4 * img_dbg2,
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);
    
    // 1. Image XYZ -> Spectrum
    // 2. Spectrum, <<Spectral sensitivity (film)>> -> Exposure
    float4 px = img[idx];
    float4 lrgb = xyz_to_linear_srgb_scalar(px);
    float4 exposure = rgb_to_exposure_film(lrgb, opts);

    img[idx] = log10(exposure) + (float)(opts->film.red.curve.bias, opts->film.green.curve.bias, opts->film.blue.curve.bias, 0) + opts->exposure_correction_film;
    
    // 3. Exposure, <<Characteristic curve (film)>>,
    //      <<Exposure correction (film)>> -> Density (film)
    float4 density = exposure_to_density_film(exposure, opts);

    // 4. Density (film), <<Spectral duffuse dye density (film)>>,
    //      <<Illuminant 1>> -> Duffused spectrum
    // 5. Duffused spectrum, <<Spectral sensitivity (paper)>> -> Exposure
    float4 _xyz;
    float8 e = density_to_exposure_paper(density, opts);
    exposure = e.s0123;
    _xyz     = e.s4567;

    img_dbg[idx] = log10(exposure) + (float)(opts->paper.red.curve.bias, opts->paper.green.curve.bias, opts->paper.blue.curve.bias, 0) + opts->exposure_correction_paper;
    
    if (opts->extra.stop == 1) {
        float4 c = xyz_to_srgb_scalar(0.1f * _xyz);
        img[idx] = c;
        return;
    }

    // 6. Exposure, <<Characteristic curve (paper)>>,
    //      <<Exposure correction (paper)>> -> Density (paper)
    density.x = log_density(log10(exposure.x),
                            opts->exposure_correction_paper,
                            &opts->paper.red.curve);
    density.y = log_density(log10(exposure.y),
                            opts->exposure_correction_paper,
                            &opts->paper.green.curve);
    density.z = log_density(log10(exposure.z),
                            opts->exposure_correction_paper,
                            &opts->paper.blue.curve);

    img_dbg2[idx] = density;
}

__kernel void process_photo2(
    __global float4 * img_in,
    __global float4 * img_out,
    __global struct PhotoProcessOpts * opts,
    float min_density
    )
{
    int idx = get_global_id(0);
    
    float4 density = img_in[idx]; //(img_in[idx] - min_density) * 1.0f;

    // 7. Density (paper), <<Spectral reflection dye density (paper)>>,
    //      <<Illuminant 2>> -> Reflected spectrum
    // 8. Reflected spectrum -> XYZ -> sRGB
    float4 xyz = (float4)(0, 0, 0, 0);
    float L = 0.0f;
    float l = 0.0f;
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant2.v[i];
        L += lt * A1931_78[i][1];
        lt /= pow(10.0f, opts->paper.red.dye.v[i]  /2 * density.x);
        lt /= pow(10.0f, opts->paper.green.dye.v[i]/2 * density.y);
        lt /= pow(10.0f, opts->paper.blue.dye.v[i] /2 * density.z);
        l += lt;
        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }

    float4 c = xyz_to_srgb_scalar(xyz / L * 100.0f); //(0.5f * xyz);
    img_out[idx] = c; //1.0 - (log10(L/l) - 0.88f) / 2.5f;
}

__kernel void process_photo3(
    __global float4 * img,
    __global struct PhotoProcessOpts * opts
    )
{
    int idx = get_global_id(0);

    int es = opts->extra.stop;
    
    float4 px = img[idx];
    float4 lrgb = xyz_to_linear_srgb_scalar(px);
    float4 exposure = rgb_to_exposure(lrgb, opts);

    float4 density = exposure_to_density(exposure, opts, 1.0f);
    float4 xyz = (float4)(0, 0, 0, 0);
    float L = 0.0f;
    exposure = (float4)(0, 0, 0, 0);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant1.v[i];
        float rr = opts->film.red.dye.v[i];
        float gg = opts->film.green.dye.v[i];
        float bb = opts->film.blue.dye.v[i];

        // TODO: is it correct to calculate L pixel-wise?
        L += lt * A1931_78[i][1];

        if (es & 1) {
            lt /= pow(10.0f, rr * density.x);
        }
        if (es & 2) {
            lt /= pow(10.0f, gg * density.y);
        }
        if (es & 4) {
            lt /= pow(10.0f, bb * density.z);
        }
        if (es & 8) {
            lt /= pow(10.0f, gg * (0.35f - 0.134f * density.x));
        }
        if (es & 16) {
            lt /= pow(10.0f, bb * (0.63f - 0.134f * density.x - 0.087f * density.y));
        }
        if (es & 32) {
            lt /= pow(10.0f, opts->film.fog.v[i]);
        }

        exposure.x += lt * 1.7f * opts->paper.red.sense.v[i];
        exposure.y += lt * opts->paper.green.sense.v[i];
        exposure.z += lt * opts->paper.blue.sense.v[i];
    }
    density = exposure_to_density_paper(exposure, opts, 1.0f);
    for(int i = 0; i < SPECTRUM_SIZE; i++) {
        float lt = opts->illuminant2.v[i];
        float rr = opts->paper.red.dye.v[i];
        float gg = opts->paper.green.dye.v[i];
        float bb = opts->paper.blue.dye.v[i];

        lt /= pow(10.0f, rr * density.x);
        lt /= pow(10.0f, gg * density.y);
        lt /= pow(10.0f, bb * density.z);

        xyz.x += lt * A1931_78[i][0];
        xyz.y += lt * A1931_78[i][1];
        xyz.z += lt * A1931_78[i][2];
    }

    if(idx == 0 || idx == 500000) {
        printf("exposure: (%f, %f, %f)\n", exposure.x, exposure.y, exposure.z);
        printf("density: (%f, %f, %f)\n", density.x, density.y, density.z);
        printf("L = %f\n", L);
    }
    float4 c = xyz_to_srgb_scalar(xyz / 3000.0f * 100.0f);
    if (es & 1024) {
        img[idx] = c;
    } else {
        img[idx] = 1 - c;
    }
}
*/
